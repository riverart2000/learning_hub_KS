name: Build and Release All Platforms
permissions:
  contents: write
  pages: write
  id-token: write

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze
        run: flutter analyze

  build_android:
    needs: analyze
    runs-on: ubuntu-latest
    env:
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Decode keystore
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        run: |
          mkdir -p android/app
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/release-keystore.jks
          cat <<EOF > android/key.properties
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=release-keystore.jks
          EOF

      - name: Get dependencies
        run: flutter pub get

      - name: Build Android APK
        run: flutter build apk --release

      - name: Build Android App Bundle
        run: flutter build appbundle --release

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab

  build_ios:
    needs: analyze
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign

      - name: Build IPA (optional)
        run: flutter build ipa --release --export-method app-store
        continue-on-error: true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifacts
          path: |
            build/ios/iphoneos/Runner.app
            build/ios/ipa/*.ipa

  build_macos:
    needs: analyze
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Install CocoaPods dependencies
        working-directory: macos
        run: pod install

      - name: Build macOS app
        run: flutter build macos --release --target-platform=darwin-universal

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: build/macos/Build/Products/Release/*.app

  build_windows:
    needs: analyze
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows app
        run: flutter build windows --release

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-app
          path: build/windows/x64/runner/Release

  build_linux:
    needs: analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop

      - name: Install dependencies
        run: flutter pub get

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev

      - name: Build Linux app
        run: flutter build linux --release

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-app
          path: build/linux/x64/release/bundle

  build_web:
    needs: analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Build web app
        run: flutter build web --release --base-href "/${{ github.event.repository.name }}/demo/"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web

  create_release:
    name: Publish GitHub Release
    needs:
      - build_android
      - build_ios
      - build_macos
      - build_windows
      - build_linux
      - build_web
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.version_tag != ''
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Package release bundles
        run: |
          mkdir -p packaged
          if [ -d artifacts/android-artifacts ]; then
            (cd artifacts/android-artifacts && zip -r ../../packaged/android.zip .)
          fi
          if [ -d artifacts/ios-artifacts ]; then
            (cd artifacts/ios-artifacts && zip -r ../../packaged/ios.zip .)
          fi
          if [ -d artifacts/macos-app ]; then
            (cd artifacts/macos-app && zip -r ../../packaged/macos.zip .)
          fi
          if [ -d artifacts/windows-app ]; then
            (cd artifacts/windows-app && zip -r ../../packaged/windows.zip .)
          fi
          if [ -d artifacts/linux-app ]; then
            (cd artifacts/linux-app && tar -czf ../../packaged/linux.tar.gz .)
          fi
          if [ -d artifacts/web-build ]; then
            rm -rf demo
            mkdir -p demo
            rsync -a artifacts/web-build/ demo/
            (cd demo && zip -r ../packaged/web.zip .)
          fi

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.version_tag }}
          name: Release ${{ inputs.version_tag }}
          files: |
            packaged/android.zip
            packaged/ios.zip
            packaged/macos.zip
            packaged/windows.zip
            packaged/linux.tar.gz
            packaged/web.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy_pages:
    name: Deploy Web Demo
    needs: build_web
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Download web artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web

      - name: Prepare demo directory
        run: |
          rm -rf demo
          mkdir -p demo
          rsync -a web/ demo/

      - name: Upload demo artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: demo

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
